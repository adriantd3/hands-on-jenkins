#!/usr/bin/groovy

pipeline {
    agent any

    options {
        disableConcurrentBuilds()
    }

    stages {
        stage("Build") {
            steps {
                script {
                    // Entramos al directorio del proyecto en tu fork
                    dir('section_4/code/cd_pipeline') {
                        // Usamos el plugin de Docker que instalaste
                        // El punto "." al final indica que el Dockerfile está en esa carpeta
                        docker.build("hands-on-jenkins/myapp:${BUILD_NUMBER}", ".")
                    }
                }
            }
        }

        stage("Deploy - Dev") {
            steps {
                script {
                    deploy('dev')
                }
            }
        }
    }
}

def deploy(environment) {
    def containerName = ''
    def port = ''

    if (environment == 'dev') {
        containerName = "app_dev"
        port = "8888"
    } 
    else {
        error "Environment not valid: ${environment}"
    }

    // Limpieza: Detenemos y borramos si ya existe de una ejecución anterior
    // Usamos el try-catch o || true para que no falle si es la primera vez que corre
    sh "docker stop ${containerName} || true"
    sh "docker rm ${containerName} || true"

    // Despliegue del nuevo contenedor
    sh "docker run -d -p ${port}:5000 --name ${containerName} hands-on-jenkins/myapp:${BUILD_NUMBER}"
    
    echo "Despliegue completado en http://localhost:${port}"
}
